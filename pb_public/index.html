<html>
    <head>
	<link href="/res/bootstrap@5.3.0.min.css" rel="stylesheet">


    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>
            Huddlerr Start Page
        </title>
    </head>
    <body x-data="mainPage">

        <nav class="navbar navbar-expand-lg bg-body-secondary" role="navigation" aria-label="main navigation">
            <div class="container">
                <a class="navbar-brand"><strong>Huddlerr</strong></a>

                <!-- This was in the bootstrap docs, and I am not 100% sure what it is for -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="#" @click=gameList()>All Games</a></li>
                        <li class="nav-item"><a class="nav-link" href="#" x-show="validLogin" @click="teamManagement()">Manage Teams</a></li>
                    </ul>

                    <button class="btn btn-outline-danger" x-show="!validLogin" disabled>Sign Up</button>
                    <button class="btn btn-outline-success" x-show="!validLogin" @click="modals.login = true; console.log('opening login')" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
                    <button type="button" class="btn btn-danger" x-show="validLogin" @click="logout()">Log Out</button>

                </div>
            </div>
        </nav>

        <div class="container">


            <!-- 
                Flow is going: 
                Show a list of current games -> take you to the scoreboard when selected
                Give the use the option to "control a game" -> check the are logged in
                give a list of games or create a new one            
            -->

            <!-- List of Current Games -->
            <template x-if="show.allGames">
                <div>
                    Current Games Being Played
                    <table id="" class="table table-striped">
                        <thead>
                            <tr>
                                <th id="">Team Name</th>
                                <th>Score</th>
                                <th id="">Game Date</th>
                                <th></th>
                            </tr>
                            
                        </thead>
                        <tbody id="">
                            <template x-for="game in games">
                                <tr @click="selectGame(game.id)">
                                    <td x-text="game.expand.team.name"></td>
                                    <td><span x-text="game.homeScore"></span> - <span x-text="game.awayScore"></span></td>
                                    <td x-text="formatDate(game.date)"></td>
                                    <td><button class="btn" disabled>View Game</button></td>
                                </tr>
                            </template>
                        </tbody>
                    
                    </table>
                    
                </div>
            </template>

            <!-- Login Page (Modal) -->
                <div class="modal fade" id="loginModal">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Log into Huddlerr</h5>
                        <button type="button" class="btn-close" @click="modals.login = false" aria-label="Close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <input class="form-control my-3" type="text" placeholder="Email Address / Username" aria-label="" x-model="credentials.username">
                      <input class="form-control my-3" type="password" placeholder="Password" aria-label="" x-model="credentials.password">
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @click="modals.login = false" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" @click="handleLogin('loginModal')">Login</button>
                      </div>
                    </div>
                  </div>
                </div>
                

            <!-- Scoreboard -->
            <template x-if="show.scoreboard">
                <div>
                    <div class="row justify-content-around">
                        <div class="col-8" id="controlPanel"> <!-- The Control Panel Needs Cleaned Up -->
                            <div class="text-center">
                                <h2 x-text="currentGame.expand.team.name"></h2>
                                <h4 x-text="formatDate(currentGame.date)"></h4>
                            </div>
                        </div>
                    </div>

                    <div class="row justify-content-around">

                    <div class="card col-5">
                        <div class="card-body">
                          <h5 class="card-title">Game Clock</h5>
                          <h6 class="card-subtitle mb-2 text-muted">Current Game Clock</h6>
                          <p class="card-text">
                            <h1  x-text="formatTime(currentGame.gameTime)">    
                            </h1>
                          </p>
                          <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="autoUpdateToggle" @click="toggleScoreboardSync()" checked>
                            <label class="form-check-label" for="autoUpdateToggle">Auto Refresh Game</label>
                          </div>                          
                        </div>
                      </div>

                      <div class="card col-5">
                        <div class="card-body">
                          <h5 class="card-title">Game Score</h5>
                          <h6 class="card-subtitle mb-2 text-muted">Current Game Score</h6>
                          <p class="card-text">
                            <h1>    
                                <span x-text="currentGame.homeScore">0</span> - <span x-text="currentGame.awayScore">0</span>
                            </h1>
                          </p>
                          <button class="btn btn-outline-primary" @click="controlGame(currentGame.id)" x-show="allowedControl">Control Game</button>
                            <button id="refreshGameButton" class="btn btn-outline-primary" @click="updateScoreboard()">Refresh Game</button>
                        </div>
                      </div>

                    </div>
                    
        
                    <hr>
        
                    <!-- Copy this from the Control Page. This is a temp placeholder. -->
        
                    <table id="" class="table table-striped">
                        <thead></thead>
                        <tbody id="gameAuditLog">

                            <template x-for="entry in currentGame.auditLog.reverse()">
                                <tr>
                                    <td x-text="entry.player"></td>
                                    <td x-text="entry.time"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>


                </div>
            </template>

            <!-- Team Game List -->
            <template x-if="show.teamGameList">
                <div>
                    <a class="" :href="'/?team=' + teamID">Link to This Team</a> <button class="btn btn-outline-primary" @click="createGame(teamID)" x-show="validLogin">Create Game</button>
                    <table id="" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Game Date</th>
                                <th>Home Score</th>
                                <th>Away Score</th>
                                <th>Game Time</th>
                                <th>Actions</th>
                            </tr>
                            
                        </thead>
                        <tbody id="">
                            <template x-for="game in games">
                                <tr>
                                    <td x-text="formatDate(game.date)"></td>
                                    <td x-text="game.homeScore"></td>
                                    <td x-text="game.awayScore"></td>
                                    <td x-text="game.gameTime"></td>
                                    <td><button class="btn btn-outline-primary" @click="selectGame(game.id)">View Game</button></td>
                                </tr>
                            </template>
                        </tbody>
                    
                    </table>
                    
                </div>
            </template>

            <!-- Control Game -->
            <template x-if="show.controlGame">
                <div>
                    <div class="row justify-content-around">
                        <div class=" col-5">
                            <button class="btn btn-outline-primary" href="#" onclick="//finishGame()" disabled>Finish Game</button>
                       
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="btnradio" id="autoSaveOff" autocomplete="off" @click="toggleAutoSave($el)">
                                <label class="btn btn-outline-danger" for="autoSaveOff">Off</label>
                              
                                <button class="btn btn-outline-primary" @click="saveGame()">Auto Save Game</button>
                              
                                <input type="radio" class="btn-check" name="btnradio" id="autoSaveOn" autocomplete="off" @click="toggleAutoSave($el)">
                                <label class="btn btn-outline-success" for="autoSaveOn">On</label>
                            </div>

                        </div>
                        <div class=" col-5">
                                <button class="button" @click="highlightSubs()">Highlight Subs</button>
                                <div class="field">
                                    <input id="autoHighlightSubsToggle" type="checkbox" name="autoHighlightSubsToggle" class="switch is-medium is-link" disabled>
                                    <label for="autoHighlightSubsToggle">Auto Highlight Subs</label>
                                  </div>

                    </div>
    
                <hr>
    
    
                <div class="row justify-content-around">
    
                    <div class="card col-5">
                        <div class="card-body">
                          <h5 class="card-title">Game Clock</h5>
                          <h6 class="card-subtitle mb-2 text-muted">Current Game Clock</h6>
                          <p class="card-text">
                            <h1  x-text="formatTime(currentGame.gameTime)">    
                            </h1>
                          </p>
                          <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" @click="toggleGameClock($el)">
                            <label class="form-check-label" for="flexSwitchCheckChecked">Game Clock Toggle</label>
                          </div>                          
                        </div>
                      </div>


                      <div class="card col-5">
                        <div class="card-body">
                          <h5 class="card-title">Game Score</h5>
                          <h6 class="card-subtitle mb-2 text-muted">Current Game Score</h6>
                          <p class="card-text">
                            <h1>    
                                <span x-text="currentGame.homeScore">0</span> - <span x-text="currentGame.awayScore">0</span>
                            </h1>
                          </p>
                          <button type="button" class="btn btn-primary" @click="addOpponentScore()">Add Opponent Score</button>
                        </div>
                      </div>

                </div>
    
                <hr>
    
                <div class="columns">
                    <div class="column">
    
                    <table class="table table-striped" >
                        <thead>
                          <tr>
                            <th><div class="">Name</div></th>
                            <th><div class="">Goals</div></th>
                            <th>PG Bar</th>
                            <th><div class="">Time</div></th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody id="playerTable">
                            <template x-for="player in players">
                                <tr>
                                    <td><span x-text="player.number"></span>: <span x-text="player.name"></span></td>
                                    <td><div class="justify-content-around"><span x-text="player.goals"></span><button class="btn btn-primary mx-3" @click="addPlayerScore(player.id)">Add Goal</button></div></td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" aria-label="Player in Time" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </td>
                                    <td><span x-text="player.time"></span></td>
                                    <td>
                                        <div class="form-check form-switch" x-data="{ id: $id('player') }">
                                            <input class="form-check-input" type="checkbox" role="switch" :id="$id('player')" @click="togglePlayerTimer(player.id)">
                                            <label class="form-check-label" :for="$id('player')">Sub Player In</label>
                                        </div> 
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                      </table>
                </div>
            </div>
    
                <hr>
                <template x-if="currentGame.auditLog">
                    <div>
                        <table id="" class="table is-fullwidth has-text-centered">
                            <thead></thead>
                            <tbody id="gameAuditLog">

                                <template x-for="(entry, index) in currentGame.auditLog.sort(auditLogSort)">
                                    <tr>
                                        <td x-text="parsePlayer(entry.player)"></td>
                                        <td x-text="entry.time"></td>
                                        <td><button @click="deleteAuditEntry(index)">Delete Event</button></td>
                                    </tr>
                                </template>

                            </tbody>
                        
                        </table>
                    </div>
                </template>
            </div>
            </template>

            <!-- Team Management -->
            <template x-if="show.allowedTeamList">
                <div>
                    <button class="btn btn-outline-primary" @click="createTeam()">Add Team</button>
                    <table id="" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>Actions</th>
                            </tr>
                            
                        </thead>
                        <tbody id="">
                            <template x-for="team in teams">
                                <tr>
                                    <td x-text="team.name"></td>
                                    <td><button class="btn btn-outline-primary" @click="findGames(team.id)">View Team Games</button> <button class="btn btn-outline-primary" @click="managePlayers(team.id)">Manage Players</button> <button class="btn btn-outline-primary" @click="editTeam(team.id)">Edit Team</button></td>
                                </tr>
                            </template>
                        </tbody>
                    
                    </table>
                    
                </div>
            </template>

            <!-- Edit Team (Modal)-->


            <div class="modal fade" id="editTeamModal">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Edit Team <span x-text="currentTeam.name"></span></h5>
                      <button type="button" class="btn-close" aria-label="Close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">

                        <!-- Imported TODO : Verify -->
                        <div class="field">
                            <label class="label">Team Name</label>
                            <div class="control has-icons-left has-icons-right">
                              <input class="input" type="text" placeholder="Team Name" x-model="currentTeam.name">
                            </div>
                          </div>

                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary" @click="updateTeam()">Update Team</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Edit Player (Modal) -->

            <div class="modal fade" id="editPlayerModal">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Edit Team <span x-text="currentPlayer.name"></span></h5>
                      <button type="button" class="btn-close" aria-label="Close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">

                        <!-- Imported TODO : Verify this -->
                        <div class="field">
                            <label class="label">Player Number</label>
                            <div class="control has-icons-left has-icons-right">
                              <input class="input" type="text" placeholder="Player Number" x-model="currentPlayer.number"> <!-- Only allow numbers -->
                            </div>
                          </div>
    
                          <div class="field">
                            <label class="label">Player Name</label>
                            <div class="control has-icons-left has-icons-right">
                              <input class="input" type="text" placeholder="Player Name" x-model="currentPlayer.name">
                            </div>
                          </div>

                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary" @click="updatePlayer()">Update Player</button>
                    </div>
                  </div>
                </div>
              </div>

            
            <!-- Manage Players -->
            <template x-if="show.managePlayers">
                <div>
                    <button class="btn btn-outline-primary" @click="createPlayer(currentTeamID)">Add Player</button>
                    <table id="" class="table table-striped">
                        <thead>
                            <tr>
                                <th>Player Number</th>
                                <th>Player Name</th>
                                <th>Actions</th>
                            </tr>
                            
                        </thead>
                        <tbody id="">
                            <template x-for="player in players">
                                <tr>
                                    <td x-text="player.number"></td>
                                    <td x-text="player.name"></td>
                                    <td><button class="btn btn-outline-primary" @click="editPlayer(player.id)">Edit Player</button></td>
                                </tr>
                            </template>
                        </tbody>
                    
                    </table>
                    
                </div>
            </template>

            




        </div>

    </body>
</html>

<script defer src="/res/alpinejs.min.js"></script> <!-- Make sure to download this locally -->

<script src="/res/pocketbase.umd.js"></script>

<script src="/res/bootstrap@5.3.0.bundle.min.js"></script>

<script>

    /* This is going to be the main SPA; handling authentication, scoreboard, and coach controls. */

     document.addEventListener('alpine:init', () => {
        Alpine.store('thisisauselessstorethatineedtodelete', {
            client: null,
            async init() {

                console.log("[*] Client Initiated");

            },
            attachClient(){
                this.client = new PocketBase('/');
            },
            accessPlayers(){

                // Do nothing yet

            }
        }),
        Alpine.data('mainPage', () => ({
            debug: false,
            games: [],
            pb: null,
            show: {},
            modals: {'login':false},
            currentGame: {expand: {team: {}}},
            credentials: {username: "", password: null},
            validLogin: false,
            refreshSpeed: 5000,
            scoreboardSync: 'undefined',
            players: [], activePlayers: [], reversePlayerKeyMap: [],
            currentPlayer: {}, currentTeam: {name: "Default"},
            autoSave: false,
            gameClock: 'undefined',
            async init () {
                // Do nothing yet

                // Easily change the pocketbase api location with this
                this.pb = new PocketBase('/');

                this.validLogin = this.pb.authStore.isValid;

                var team = getSession();
                if (team == null){
                    this.gameList();
                } else {
                    // pull team games
                    this.findGames(team);
                }

            },
            async logout(){
                this.pb.authStore.clear();
                this.validLogin = this.pb.authStore.isValid;
            },
            async parsePlayer(player){

                try {                
                    if (player != '000000'){
                        return this.players[this.reversePlayerKeyMap[player]].name;
                    } else {
                        return player;
                    }
                } catch (err){ return player; }
                
            },
            async handleLogin(element){

                try {

                const authData = await this.pb.collection('users').authWithPassword(this.credentials.username, this.credentials.password);
                this.password = null;
                this.validLogin = this.pb.authStore.isValid;

                // We know this modal's name, as it is required by the bootstrap data field. Should I even pass the element?

                const loginModal = bootstrap.Modal.getInstance(document.getElementById(element));
                loginModal.hide();

                    
                } catch (err){
                    //console.log(err);
                    alert("invalid login");
                }


                if (this.debug){
                    console.log(this.pb.authStore.isValid);
                    console.log(this.pb.authStore.token);
                    console.log(this.pb.authStore.model.id);
                }

            },
            async gameList(){
                const games = await this.pb.collection('games').getFullList(200 , {
                    sort: '-created',
                    expand: "team"
                });
                this.games = games;

                if (this.debug){
                    console.log("[*] Retrieve Games");
                    console.log(games);
                }
                this.showLayer("allGames");
            },
            async teamManagement() {
                this.teams = [];
                // Find Authorized Teams
                const record = await this.pb.collection('teams').getFullList(200, {
                    sort: '-created',
                    filter: 'user="'+ this.pb.authStore.model.id +'"'
                })
                this.teams = record;
                this.showLayer("allowedTeamList");
            },
            async managePlayers(teamID){
                this.players = [];
                const players = await this.pb.collection('players').getFullList(200, {
                    sort: '-number',
                    filter: 'team="'+ teamID +'"'
                })
                this.players = players;
                this.currentTeamID = teamID;
                this.showLayer("managePlayers");
            },
            async controlTeam(teamID){
                // Do something
            },
            async controlGame(gameID){
                this.showLayer('controlGame'); // I don't understand why I need this twice yet
                if (this.scoreboardSync != 'undefined'){
                    clearInterval(this.scoreboardSync);
                    this.scoreboardSync = 'undefined';
                }

                const currentGame = await this.pb.collection('games').getOne(gameID, {
                    expand: 'team',
                });
                this.currentGame = currentGame;

                this.players = [];
                const players = await this.pb.collection('players').getFullList(200, {
                    sort: '-number',
                    filter: 'team="'+ this.currentGame.team +'"'
                })
                
                var keys = {};
                for (let i in players){
                    keys[players[i].id] = i;
                    players[i].time = 0;
                    players[i].goals = 0;
                }

                if (this.currentGame.auditLog == null){
                    this.currentGame.auditLog = [];
                }

                if (this.currentGame.gameData){
                    for (let i in this.currentGame.gameData.players){
                        players[keys[i]].time = this.currentGame.gameData.players[i];
                    }
                }

                this.players = players;
                this.reversePlayerKeyMap = keys;

                this.rebuildFromAuditLog();
                
                this.showLayer('controlGame');
            },
            async updateScoreboard(){
                console.log("Updated Game");
                this.currentGame = await this.pb.collection('games').getOne(this.currentGame.id, {
                    expand: 'team',
                });

            },
            async createTeam(){
                try {
                    if (this.pb.authStore.isValid){
                        const record = await this.pb.collection('teams').create({"name": "New Team", "user": this.pb.authStore.model.id});
                        this.teamManagement();
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            async editTeam(teamID){ // May not need this anymore
                try {
                    if (this.pb.authStore.isValid){
                        const record = await this.pb.collection('teams').getOne(teamID, {});
                        this.currentTeam = record;
                        var t = new bootstrap.Modal(document.getElementById('editTeamModal')).show();
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            async updateTeam(){
                try {
                    if (this.pb.authStore.isValid){
                        const record = await this.pb.collection('teams').update(this.currentTeam.id, this.currentTeam);
                        bootstrap.Modal.getInstance(document.getElementById('editTeamModal')).hide();
                        this.teamManagement();
                        this.currentTeam = {};
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            async createPlayer(teamID){
                try {
                    if (this.pb.authStore.isValid){
                        const record = await this.pb.collection('players').create({"name": "New Player", "team": teamID});
                        this.managePlayers(teamID);
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            async editPlayer(playerID){ // May not need this anymore
                try {
                    if (this.pb.authStore.isValid){
                        const record = await this.pb.collection('players').getOne(playerID, {});
                        this.currentPlayer = record;
                        var t = new bootstrap.Modal(document.getElementById('editPlayerModal')).show();
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            async updatePlayer(){
                try {
                    if (this.pb.authStore.isValid){
                        const record = await this.pb.collection('players').update(this.currentPlayer.id, this.currentPlayer);
                        //
                        this.managePlayers(this.currentPlayer.team);
                        this.currentPlayer = {};
                        bootstrap.Modal.getInstance(document.getElementById('editPlayerModal')).hide();
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            async createGame(teamID){
                try {
                    if (this.pb.authStore.isValid){
                        var date = new Date();
                        date = date.toJSON();
                        const record = await this.pb.collection('games').create({"date": date, "team": teamID});
                        this.findGames(teamID)
                    }
                } catch (err) {
                    console.log(err);
                }
            },
            async findGames(teamID){
                this.teamID = teamID;
                this.verifiedTeam = false;
                // If user is team coach, show control buttons. or maybe put it somewhere else
                const games = await this.pb.collection('games').getFullList(200, {
                    sort: '-created',
                    filter: 'team="'+ teamID +'"'
                })
                this.games = games;
                this.showLayer('teamGameList');
            },
            async toggleScoreboardSync(){
                if (this.scoreboardSync == 'undefined'){
                    this.scoreboardSync = setInterval(() => this.updateScoreboard(), this.refreshSpeed);
                } else {
                    clearInterval(this.scoreboardSync);
                    this.scoreboardSync = 'undefined';
                }
            },
            async toggleGameClock(element){
                if (this.gameClock == 'undefined'){
                    this.gameClock = setInterval(() => this.handleGameTick(), 1000);
                    element.checked = true;
                } else {
                    clearInterval(this.gameClock);
                    this.gameClock = 'undefined';
                    element.checked = false;
                }
            },
            async toggleAutoSave(element){

                if (this.autoSave){
                    this.autoSave = false;
                    element.checked = false;
                } else {
                    this.saveGame(); // Do this once so it runs even if the game clock is not running
                    this.autoSave = true;
                    element.checked = true;
                }
            },
            async handleGameTick(){
                // Instead of so many multiple clocks, this one will check players to add time, and handle save game if those options are set.

                // TODO : Forward Game Clock
                this.currentGame.gameTime++;

                // TODO : Forward Player Clocks for all players in
                var keys = Object.keys(this.activePlayers);
                for (let i=0; i<keys.length; i++){
                    this.players[this.reversePlayerKeyMap[keys[i]]].time++;
                    //this.currentGame.gameData[keys[i]].time++;
                }

                // TODO : Check Autosave and Perform action
                if ((this.autoSave) && (this.currentGame.gameTime % 5 == 0)){
                    console.log("Auto Saved Game") // DEBUG : take this out after testing
                    saveGame();
                }

            },
            async togglePlayerTimer(player){
                if(this.activePlayers[player] != true){
                    this.activePlayers[player] = true;
                } else {
                    delete this.activePlayers[player];
                }
            },
            async deleteAuditEntry(index){
               this.currentGame.auditLog.splice(index,index+1);
               this.rebuildFromAuditLog();
            },
            async rebuildFromAuditLog(){
                this.currentGame.awayScore = 0;
                this.currentGame.homeScore = 0;

                for (let i in this.players){
                    this.players[i].goals = 0;
                }

                for (let i in this.currentGame.auditLog){
                    if (this.currentGame.auditLog[i].player == "000000"){
                        this.currentGame.awayScore++;
                    } else {
                        this.players[this.reversePlayerKeyMap[this.currentGame.auditLog[i].player]].goals++;
                        this.currentGame.homeScore++;
                    }
                }
            },
            async addOpponentScore(){
                // TODO : Update the Audit Log
                this.currentGame.auditLog.push({"player":"000000", "time":this.currentGame.gameTime});

                // Update the Current Game
                this.currentGame.awayScore++;

            },
            async addPlayerScore(player){
                // TODO : Update the Audit Log
                this.currentGame.auditLog.push({"player":player, "time":this.currentGame.gameTime});
                this.players[this.reversePlayerKeyMap[player]].goals++;

                // Update the Current Game
                this.currentGame.homeScore++;

            },
            async saveGame(){
                // TODO : Add an option to save this data locally for offline usage, javascript localStorage I think?
                var gameData = {players: {}}
                for (let i in this.players){
                    gameData.players[this.players[i].id] = this.players[i].time;
                }
                //console.log(gameData);

                this.currentGame.gameData = gameData;
                const record = await this.pb.collection('games').update(this.currentGame.id, this.currentGame);
            },
            async selectGame(game){
                this.allowedControl = false;

                
                const currentGame = await this.pb.collection('games').getOne(game, {
                    expand: 'team',
                });
                this.currentGame = currentGame;

                this.scoreboardSync = setInterval(() => this.updateScoreboard(), this.refreshSpeed);

                if (this.currentGame.auditLog == null){
                    this.currentGame.auditLog = [];
                }

                if (this.pb.authStore.isValid){
                    if (currentGame.expand.team.user == this.pb.authStore.model.id){
                        this.allowedControl = true;
                        console.log("This user is allowed to control this game");
                    }
                }

                if (this.debug){
                    console.log("[v] Game ID: ");
                    console.log(game);
                }
                this.showLayer("scoreboard");
            },
            async highlightSubs(){

                // Grab the top x players of time and the lowest.

                // Create new list of players and sort them from highest to lowest
                var currentPlayers = this.players;
                currentPlayers.sort((a,b) => {return b.time - a.time});

                // Check if the player is in

                // ...

                // Mark the player or return?

                // ...

                // DEBUG : This is the default output for now until I figure out where to ship this, then delete.
                console.log(currentPlayers[0]);
                console.log(currentPlayers[1]);
                console.log(currentPlayers[currentPlayers.length - 1]); //  But also > 0


            },
            async showLayer(layer){
                if (this.debug){
                    console.log("[v] Showing Layer:")
                    console.log(layer);
                }

                if ((this.scoreboardSync != 'undefined') && (layer != 'scoreboard')){
                    clearInterval(this.scoreboardSync);
                    this.scoreboardSync = 'undefined';
                }

                if ((this.gameClock != 'undefined') && (layer != 'controlGame')){
                    clearInterval(this.gameClock);
                    this.gameClock = 'undefined';
                }


                var keys = Object.keys(this.show);
                for (let i=0; i<keys.length; i++){
                    this.show[keys[i]] = false;
                }

               this.show[layer] = true;
            }
        }))
      })

// This is in a common functions page, staying here for testing purposes for now
function formatTime(time){
    // Convert Seconds to 00:00 format
    temp = "";

    // Create Minutes
    minutes = Math.floor(time/60);
    if (minutes < 10) {
        temp = "0" + String(minutes);
    } else {
        temp += String(minutes);
    }
    temp += ":";

    // Create Seconds
    seconds = time%60;
    if (seconds < 10){
        temp += "0" + seconds;
    } else {
        temp += seconds;
    }

    // Return the String
    return temp;
}

function formatDate(d){
    //date.toLocaleDateString(); // 5/12/2020
    var temp = new Date(d);
    return temp.toDateString();
}

function getSession(){

// We need to do input validation on this

    var url = new URL(window.location.href);
    var c = url.searchParams.get("team");
    return c;

}

function auditLogSort(a,b){
    return b.time - a.time;
}
</script>
